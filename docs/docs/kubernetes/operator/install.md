# Helm

[Helm], which is a popular package manager for Kubernetes, allows installing applications from parameterized YAML manifests called Helm [charts].

The Helm chart is available on GitHub in [https://github.com/aquasecurity/trivy-operator](https://github.com/aquasecurity/trivy-operator) under `/deploy/helm` and is also hosted in a Chart repository for your convenience under [https://aquasecurity.github.io/helm-charts/](https://aquasecurity.github.io/helm-charts/).

Please refer to the chart's [values] file for configuration options.

## Example - Chart repository

This will install the operator in the `trivy-system` namespace and configure it to scan all namespaces, except `kube-system` and `trivy-system`:

```bash
helm repo add aqua https://aquasecurity.github.io/helm-charts/
helm repo update
helm install trivy-operator aqua/trivy-operator \
   --namespace trivy-system \
   --create-namespace \
   --set="trivy.ignoreUnfixed=true" \
   --version {{ var.chart_version }}
```

## Example - Download chart

This will install the operator in the `trivy-system` namespace and configure it to scan all namespaces, except `kube-system` and `trivy-system`:

```bash
git clone --depth 1 --branch {{ git.tag }} https://github.com/aquasecurity/trivy-operator.git
cd trivy-operator
helm install trivy-operator ./deploy/helm \
--namespace trivy-system \
--create-namespace \
--set="trivy.ignoreUnfixed=true"
```

## Uninstalling

You can uninstall the operator with the following command:

```
helm uninstall trivy-operator -n trivy-system
```

You have to manually delete custom resource definitions created by the `helm install` command:

!!! danger
    Deleting custom resource definitions will also delete all security reports generated by the operator.

    ```
    kubectl delete crd vulnerabilityreports.aquasecurity.github.io
    kubectl delete crd clustervulnerabilityreports.aquasecurity.github.io
    kubectl delete crd configauditreports.aquasecurity.github.io
    kubectl delete crd ciskubebenchreports.aquasecurity.github.io
    kubectl delete crd kubehunterreports.aquasecurity.github.io
    kubectl delete crd clusterconfigauditreports.aquasecurity.github.io
    kubectl delete crd clustercompliancereports.aquasecurity.github.io
    kubectl delete crd clustercompliancedetailreports.aquasecurity.github.io
    ```

# kubectl

Kubernetes Yaml deployment files are available on GitHub in [https://github.com/aquasecurity/trivy-operator](https://github.com/aquasecurity/trivy-operator) under `/deploy/static`.

## Example - Deploy from GitHub

This will install the operator in the `trivy-system` namespace and configure it to scan all namespaces, except `kube-system` and `trivy-system`:

```bash
kubectl apply -f https://raw.githubusercontent.com/aquasecurity/trivy-operator/{{ git.tag }}/deploy/static/trivy-operator.yaml
```

## Uninstalling

!!! danger
    Uninstalling the operator and deleting custom resource definitions will also delete all generated security reports.

You can uninstall the operator with the following command:

```
kubectl delete -f https://raw.githubusercontent.com/aquasecurity/trivy-operator/{{ git.tag }}/deploy/static/trivy-operator.yaml
```

# Verify installation

To confirm that the operator is running, check that the `trivy-operator` Deployment in the `trivy-operator` namespace is available and all its containers are ready:

```bash
$ kubectl get deployment -n trivy-system
NAME                 READY   UP-TO-DATE   AVAILABLE   AGE
trivy-operator   1/1     1            1           11m
```

If installed with Helm, check for the Helm release called `trivy-operator` with status `deployed`:

```console
$ helm list -n trivy-operator
NAME              	NAMESPACE         	REVISION	UPDATED                             	STATUS  	CHART                   	APP VERSION
trivy-operator	trivy-system	1       	2021-01-27 20:09:53.158961 +0100 CET	deployed	trivy-operator-{{ var.chart_version }}	{{ git.tag[1:] }}
```

If for some reason it's not ready yet, check the logs of the `trivy-operator` Deployment for errors:

```bash
kubectl logs deployment/trivy-operator -n trivy-system
```

Refer to the [troubleshooting](troubleshooting) section for more.


## Advanced Configuration

You can configure Trivy-Operator to control it's behavior and adapt it to your needs. Aspects of the operator machinery are configured using environment variables on the operator Pod, while aspects of the scanning behavior are controlled by ConfigMaps and Secrets.
To learn more, please refer to the [Configuration](config) documentation.

# Upgrade

We recommend that you upgrade Trivy Operator often to stay up to date with the latest fixes and enhancements.

However, at this stage we do not provide automated upgrades. Therefore, uninstall the previous version of the operator
before you install the latest release.

!!! warning
    Consult release notes and changelog to revisit and migrate configuration settings which may not be compatible
    between different versions.


[Helm]: https://helm.sh/
[charts]: https://helm.sh/docs/topics/charts/
[values]: https://raw.githubusercontent.com/aquasecurity/trivy-operator/{{ git.tag }}/deploy/helm/values.yaml
[troubleshooting]: ../troubleshooting
[config]: ../configuration